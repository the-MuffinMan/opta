environments:
  - name: staging
    path: "../env/opta.yml"
    variables:
      max_nodes: 2
name: service-flyte
modules:
  - name: db
    type: aws-postgres
  - name: s3
    type: aws-s3
    bucket_name: "{parent_name}-{layer_name}"
  - name: flyterole
    type: aws-iam-role
    allowed_k8s_services:
      - namespace: "*"
        service_name: "*"
    links:
      - s3: ["write"]
  - type: helm-chart
    chart: ../../../../flyte/helm
    namespace: flyte
    create_namespace: true
    values_file: ./values-eks.yaml
    values:
      postgres:
        enabled: false
      db:
        database:
          port: 5432
          username: "${{module.db.db_user}}"
          host: "${{module.db.db_host}}"
          dbname: "${{module.db.db_name}}"
      common:
        ingress:
          host: "flyte.{parent.domain}"
          annotations:
            kubernetes.io/ingress.class: "nginx"
        databaseSecret:
          secretManifest:
            stringData:
              pass.txt: "${{module.db.db_password}}"
      storage:
        bucketName: "{parent_name}-{layer_name}"
        s3:
          region: "us-east-1"
      flyteadmin:
        serviceAccount:
          create: true
          annotations:
            eks.amazonaws.com/role-arn: "${{module.flyterole.role_arn}}"
      datacatalog:
        serviceAccount:
          create: true
          annotations:
            eks.amazonaws.com/role-arn: "${{module.flyterole.role_arn}}"
      flytepropeller:
        serviceAccount:
          create: true
          annotations:
            eks.amazonaws.com/role-arn: "${{module.flyterole.role_arn}}"
      workflow_scheduler:
        config:
          scheduler:
            eventScheduler:
              scheduleRole: "${{module.flyterole.role_arn}}"
      configmap:
        remoteData:
          region: "us-east-1"
          scheme: aws
          signedUrls:
            durationMinutes: 3
      cluster_resource_manager:
        enabled: true
        config:
          cluster_resources:
            customData:
              - production:
                  - defaultIamRole:
                      value: "${{module.flyterole.role_arn}}"
                  - projectQuotaCpu:
                      value: "5"
                  - projectQuotaMemory:
                      value: "4000Mi"
              - staging:
                  - defaultIamRole:
                      value: "${{module.flyterole.role_arn}}"
                  - projectQuotaCpu:
                      value: "2"
                  - projectQuotaMemory:
                      value: "3000Mi"
              - development:
                  - defaultIamRole:
                      value: "${{module.flyterole.role_arn}}"
                  - projectQuotaCpu:
                      value: "4"
                  - projectQuotaMemory:
                      value: "3000Mi"